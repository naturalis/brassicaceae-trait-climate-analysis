---
title: "OMI with Envirem data"
author: "Marit Kuijt"
date: "2023-02-14"
output: html_document
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = "C:/Users/marit/OneDrive/Documenten/Masterstage Naturalis/brassicaceae-trait-climate-analysis")
```

```{r}
library(geodata)
options(stringsAsFactors = FALSE)
library(raster)
library(tidyverse)
library(sp)
library(adehabitatMA)
library(optparse)
library(yaml)
library(dplyr)
library(ade4)
library(tibble)
library(logger)
library(CoordinateCleaner)
library(fuzzySim)
library(factoextra)
library(ggforce)
library(ggalt)
library(ggtree)
library(usdm)
library(subniche)
library(knitr)
library(phylolm)
library(ggnewscale)
library(ggplot2)
library(ggpubr)
library(ape)
library(phytools)
```
#Read Data
##GIS data
```{r add_layers}
# Read ENVIREM data and stack
remove(WorldENVIREM)
WorldENVIREM <- raster()

# The location of the TIFF file with the stacked layers described directly above
files.names <- list.files("./Data/ENVIREM")
# Turn the file names into layer names: strip the prefix (which might include
# the resolution) and strip the file extension
gis.layers.names <- files.names
gis.layers.names <- gsub('./Data/wc2.1_10m_','',gis.layers.names)
gis.layers.names <- gsub('.tif','',gis.layers.names)

gis.layers <- c()
# Iterate over files
for (j in 1:length(files.names)) {
  
  # Stack with previously read layers
  WorldENVIREM <- stack(
    WorldENVIREM,
    
    # Read as raster
    raster(
      
      # Construct file name
      paste("./Data/ENVIREM/", files.names[j], sep = "")
    )
  )
}

rm(gis.layers.names, files.names, j)
#plot(WorldENVIREM)
```
```{r}
gis.layers.WE.spdf <- as(WorldENVIREM, "SpatialPixelsDataFrame")
sp::proj4string(gis.layers.WE.spdf) <- crs("+proj=longlat +ellps=WGS84", doCheckCRSArgs = T)
```

```{r add_layers}
## Read Bioclim data and stack
remove(WorldBioClim)
WorldBioClim <- raster()

# The location of the TIFF file with the stacked layers described directly above
files.names <- list.files("./Data/wc2.1_10m")
# Turn the file names into layer names: strip the prefix (which might include
# the resolution) and strip the file extension
gis.layers.names <- files.names
gis.layers.names <- gsub('./Data/wc2.1_10m_','',gis.layers.names)
gis.layers.names <- gsub('.tif','',gis.layers.names)

gis.layers <- c()
# Iterate over files
for (i in 1:length(files.names)) {
  
  # Stack with previously read layers
  WorldBioClim <- stack(
    WorldBioClim,
    
    # Read as raster
    raster(
      
      # Construct file name
      paste("./Data/wc2.1_10m/", files.names[i], sep = "")
    )
  )
}

rm(gis.layers.names, files.names, i)
plot(WorldBioClim)
```
```{r}
gis.layers.WBC.spdf <- as(WorldBioClim, "SpatialPixelsDataFrame")
sp::proj4string(gis.layers.spdf) <- crs("+proj=longlat +ellps=WGS84", doCheckCRSArgs = T)
```

##Occurrence data
```{r}
occurrences.spdf <- new(
    "SpatialPointsDataFrame", 
    coords = structure(
        numeric(0), 
        .Dim = c(0L, 2L),
        .Dimnames = list( NULL, c("x", "y") )
    ),  
    bbox = structure(
        c(1,1,1,1), 
        .Dim = c(2L, 2L),                         
        .Dimnames = list( c("x","y"), c("min","max") )
    ),
    proj4string = crs("+proj=longlat +ellps=WGS84", doCheckCRSArgs = T)
) 
```

```{r}
# Populate the empty dataframe with lat/lon values from the taxa list
gbif_summary <- read.csv("Data/gbif_summary.csv")
# set for example i in 1:100 in the case of memory limits 
taxa.names <- gbif_summary[grep("Lepidium", gbif_summary$Name),]
taxa.names <- taxa.names$Name[taxa.names$BrassiBase_status == "accepted" & taxa.names$gbif_records_w_coordinates > 20]
for (j in 1:50) {
    
    # Prevent out of bounds errors
    if (j > length(taxa.names)) {
        break
    }
delayedAssign("do.next", {next})
  
	# Read occurrences
    species.key <- gbif_summary$speciesKey[gbif_summary$Name == taxa.names[j] & !duplicated(gbif_summary$Name)]
    csv.file <- paste("Data/gbif_occurrences_per_key/", species.key, ".csv", sep = "")
    csv.data <- read.csv(csv.file)
    #tryCatch(csv.data <- read.csv(csv.file), error=function(e) force(do.next))
    points.df <- dplyr::select(
        csv.data,
        decimalLongitude,
        decimalLatitude,
        species
    )
    
    #Coordinate Cleaner
    points.df <- na.omit(points.df)
    tryCatch(cc_cap(points.df, lon = "decimalLongitude", lat = "decimalLatitude", species = "species"), error=function(e) force(do.next))
    tryCatch(cc_cen(points.df, lon = "decimalLongitude", lat = "decimalLatitude", species = "species"), error=function(e) force(do.next))
    tryCatch(cc_dupl(points.df, lon = "decimalLongitude", lat = "decimalLatitude", species = "species"), error=function(e) force(do.next))
    tryCatch(cc_equ(points.df, lon = "decimalLongitude", lat = "decimalLatitude"), error=function(e) force(do.next))
    tryCatch(cc_gbif(points.df, lon = "decimalLongitude", lat = "decimalLatitude", species = "species"), error=function(e) force(do.next))
    tryCatch(cc_inst(points.df, lon = "decimalLongitude", lat = "decimalLatitude", species = "species"), error=function(e) force(do.next))
    tryCatch(cc_outl(points.df, lon = "decimalLongitude", lat = "decimalLatitude", species = "species"), error=function(e) force(do.next))
    tryCatch(cc_sea(points.df, lon = "decimalLongitude", lat = "decimalLatitude"), error=function(e) force(do.next))
    tryCatch(cc_zero(points.df, lon = "decimalLongitude", lat = "decimalLatitude"), error=function(e) force(do.next))
    
    if(nrow(points.df) < 20) {next}
    sp::coordinates(points.df) <- ~ decimalLongitude + decimalLatitude
    proj4string(points.df) <- crs("+proj=longlat +ellps=WGS84", doCheckCRSArgs = T)
    
    # Populate SpatialPointsDataFrame for focal taxon
    focal.spdf <- SpatialPointsDataFrame(
    	points.df, 
    	data.frame(species = rep(taxa.names[j], NROW(points.df))), 
    	proj4string = crs("+proj=longlat +ellps=WGS84", doCheckCRSArgs = T)
    )
    proj4string(focal.spdf) <- crs("+proj=longlat +ellps=WGS84", doCheckCRSArgs = T)
    
    # Append to cumulative data frame
    occurrences.spdf <- rbind(occurrences.spdf, focal.spdf)
    
}
```

```{r}
names <- unique(occurrences.spdf$species)
```

##GIS data per cell
```{r}
traitvalues.df <- slot(gis.layers.WE.spdf, "data")
traitvalues.df <- tibble::rowid_to_column(traitvalues.df, "ID")
traitvalues.df <- na.omit(traitvalues.df)
```

##Presence/absence matrix per cell
```{r}
npoints <- adehabitatMA::count.points(occurrences.spdf, gis.layers.WE.spdf)
noccurrences.df <- slot(npoints, "data")
noccurrences.df <- tibble::rowid_to_column(noccurrences.df, "ID")
noccurrences.df <- subset(noccurrences.df, noccurrences.df$ID %in% traitvalues.df$ID)
noccurrences.df <- subset(noccurrences.df, select = -ID)
noccurrences.df[noccurrences.df > 0] <- 1
```


#OMI analysis
##First a PCA
```{r}
traitvalues.dudi <- ade4::dudi.pca(
    traitvalues.df[2:length(traitvalues.df)], 
    scannf = F
)
```

##Then the OMI analysis
```{r}
niche.dudi <- ade4::niche(traitvalues.dudi, noccurrences.df, scannf = F)
scatter(niche.dudi)
screeplot(niche.dudi)
MeanBioClim <- niche.dudi$tab
kable(niche.param(niche.dudi))
```

```{r}
rbind(
  Eigenvalue = niche.dudi$eig,
  Proportion = niche.dudi$eig/sum(niche.dudi$eig),
  Cumulative = cumsum(niche.dudi$eig)/sum(niche.dudi$eig))
```

##Save output
```{r}
write.csv(niche.dudi$tab, file = "./Results/niche_traits_merged_Lepidium", append = T, quote = F )
```


#Read Tree and filter to species in OMI
```{r}
MetaData1 <- read_csv("./Data/2e.metadata.csv")
BrassiToL <- read.tree("Data/species_tree.tre")
names_to_drop <- setdiff(MetaData1$Name, names)
tips <- MetaData1$Library_ID[MetaData1$Name %in% names_to_drop]
BrassiToL_Lepidium <- drop.tip(BrassiToL, tips)
```

#Combine trait data of species and enviroment
```{r}
Growth_Form_ID <- subset(MetaData1, Genus == "Lepidium", select = c(Library_ID, Growth_habit, Name))
Growth_Form <- data.frame(Growth_Form_ID)
rownames(Growth_Form) <- Growth_Form_ID$Library_ID
Growth_Form <- subset(Growth_Form, select = c(Growth_habit, Name))
```

```{r}
Growth_Form$Growth_habit[Growth_Form$Growth_habit == "H"] <- 0
Growth_Form$Growth_habit[Growth_Form$Growth_habit == "W"] <- 1
Growth_Form$Growth_habit <- base::as.numeric(Growth_Form$Growth_habit)
```

```{r}
rownames(MeanBioClim) <- gsub(".", " ", rownames(MeanBioClim), fixed = T)
common1 <- intersect(rownames(MeanBioClim), Growth_Form_ID$Name)
MeanBioClim <- MeanBioClim[common1,]
SpeciesNames <- rownames(MeanBioClim)
```

```{r}
common2 <- intersect(rownames(Growth_Form), BrassiToL_Lepidium$tip.label)
Growth_Form <- Growth_Form[common2,]
```

##Add the ENVIREM OMI-transformed climatic data for each species
```{r}
for (i in 1:length(SpeciesNames)) {
  Growth_Form$annualPET[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_annualPET[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$aridityIndexThornthwaite[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_aridityIndexThornthwaite[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$climaticMoistureIndex[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_climaticMoistureIndex[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$continentality[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_continentality[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$embergerQ[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_embergerQ[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$growingDegDays0[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_growingDegDays0[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$growingDegDays5[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_growingDegDays5[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$maxTempColdest[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_maxTempColdest[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$minTempWarmest[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_minTempWarmest[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$monthCountByTemp10[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_monthCountByTemp10[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$PETColdestQuarter[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_PETColdestQuarter[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$PETDriestQuarter[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_PETDriestQuarter[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$PETseasonality[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_PETseasonality[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$PETWarmestQuarter[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_PETWarmestQuarter[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$PETWettestQuarter[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_PETWettestQuarter[rownames(MeanBioClim) == SpeciesNames[i]]
  
  Growth_Form$thermicityIndex[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$current_10arcmin_thermicityIndex[rownames(MeanBioClim) == SpeciesNames[i]]
}
```

```{r}
for (i in 1:length(SpeciesNames)) {
  Growth_Form$BioClim1[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_1[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim2[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_2[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim3[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_3[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim4[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_4[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim5[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_5[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim6[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_6[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim7[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_7[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim8[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_8[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim9[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_9[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim10[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_10[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim11[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_11[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim12[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_12[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim13[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_13[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim14[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_14[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim15[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_15[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim16[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_16[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim17[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_17[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim18[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_18[rownames(MeanBioClim) == SpeciesNames[i]]
  Growth_Form$BioClim19[Growth_Form$Name == SpeciesNames[i]] <- MeanBioClim$wc2.1_10m_bio_19[rownames(MeanBioClim) == SpeciesNames[i]]
}
```


```{r}
Growth_Form <- na.omit(Growth_Form)
```

```{r}
Growth_Form_Name <- subset(Growth_Form, select = Name)
Growth_Form_Trait <- subset(Growth_Form, select = Growth_habit)
  Growth_Form_Trait$Growth_habit <- as.factor(Growth_Form_Trait$Growth_habit)
Growth_Form_annualPET <- subset(Growth_Form, select = annualPET)
```

```{r}
Growth_Form$Growth_habit <- factor(Growth_Form$Growth_habit, levels = 0:1, labels = c(0,1))
```
#Plot tree
```{r}
p <- ggtree(BrassiToL_Lepidium) %<+% MetaData1 +
  geom_tiplab(size = 3) +
  geom_tiplab(aes(label = Name), offset = 2, size = 3)
p2 <- gheatmap(p, Growth_Form_Trait, offset = 5, width = 0.1)
p3 <- p2 + new_scale_fill()
gheatmap(p3, Growth_Form_annualPET, offset = 8, width = 0.1) + scale_fill_continuous(na.value = "white")

```

#Boxplots
##Make boxplots per variable ENVIREM
```{r boxplots}

annualPET <- ggplot(Growth_Form, aes(Growth_habit, annualPET, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

PETColdest <- ggplot(Growth_Form, aes(Growth_habit, PETColdestQuarter, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

PETWettest <- ggplot(Growth_Form, aes(Growth_habit, PETWettestQuarter, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")
      
PETDriest <- ggplot(Growth_Form, aes(Growth_habit, PETDriestQuarter, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

PETseasonality <- ggplot(Growth_Form, aes(Growth_habit, PETseasonality, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

PETWarmest <- ggplot(Growth_Form, aes(Growth_habit, PETWarmestQuarter, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Thornthwaite <- ggplot(Growth_Form, aes(Growth_habit, aridityIndexThornthwaite, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

climaticMoisture <- ggplot(Growth_Form, aes(Growth_habit, climaticMoistureIndex, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

continentality <- ggplot(Growth_Form, aes(Growth_habit, continentality, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

embergerQ <- ggplot(Growth_Form, aes(Growth_habit, embergerQ, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

growing0 <- ggplot(Growth_Form, aes(Growth_habit, growingDegDays0, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

growing5 <- ggplot(Growth_Form, aes(Growth_habit, growingDegDays5, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

maxTempColdest <- ggplot(Growth_Form, aes(Growth_habit, maxTempColdest, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

minTempWarmest <- ggplot(Growth_Form, aes(Growth_habit, minTempWarmest, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

month10 <- ggplot(Growth_Form, aes(Growth_habit, monthCountByTemp10, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

thermicity <- ggplot(Growth_Form, aes(Growth_habit, thermicityIndex, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

```

```{r}
ggarrange(PETDriest + rremove("xlab") + rremove("legend"), minTempWarmest + rremove("xlab") + rremove("legend"), PETWarmest + rremove("xlab") + rremove("legend"), Thornthwaite + rremove("xlab") + rremove("legend"), month10 + rremove("xlab") + rremove("legend"), growing5 + rremove("xlab") + rremove("legend"), thermicity + rremove("xlab") + rremove("legend"), annualPET + rremove("xlab") + rremove("legend"), growing0 + rremove("xlab") + rremove("legend"), climaticMoisture + rremove("xlab") + rremove("legend"), PETseasonality + rremove("xlab") + rremove("legend"), maxTempColdest + rremove("xlab") + rremove("legend"), PETColdest + rremove("xlab") + rremove("legend"), PETWettest + rremove("xlab") + rremove("legend"), embergerQ + rremove("xlab") + rremove("legend"), continentality + rremove("xlab") + rremove("legend"), ncol = 4, nrow = 4)
```

##Make boxplots per variable BioClim
```{r boxplots}

Bio1 <- ggplot(Growth_Form, aes(Growth_habit, BioClim1, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio2 <- ggplot(Growth_Form, aes(Growth_habit, BioClim2, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio3 <- ggplot(Growth_Form, aes(Growth_habit, BioClim3, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")
      
Bio4 <- ggplot(Growth_Form, aes(Growth_habit, BioClim4, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio5 <- ggplot(Growth_Form, aes(Growth_habit, BioClim5, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio6 <- ggplot(Growth_Form, aes(Growth_habit, BioClim6, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio7 <- ggplot(Growth_Form, aes(Growth_habit, BioClim7, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio8 <- ggplot(Growth_Form, aes(Growth_habit, BioClim8, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio9 <- ggplot(Growth_Form, aes(Growth_habit, BioClim9, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio10 <- ggplot(Growth_Form, aes(Growth_habit, BioClim10, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio11 <- ggplot(Growth_Form, aes(Growth_habit, BioClim11, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio12 <- ggplot(Growth_Form, aes(Growth_habit, BioClim12, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio13 <- ggplot(Growth_Form, aes(Growth_habit, BioClim13, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio14 <- ggplot(Growth_Form, aes(Growth_habit, BioClim14, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio15 <- ggplot(Growth_Form, aes(Growth_habit, BioClim15, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio16 <- ggplot(Growth_Form, aes(Growth_habit, BioClim16, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio17 <- ggplot(Growth_Form, aes(Growth_habit, BioClim17, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio18 <- ggplot(Growth_Form, aes(Growth_habit, BioClim18, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio19 <- ggplot(Growth_Form, aes(Growth_habit, BioClim19, group = Growth_habit, fill = Growth_habit)) +
  geom_boxplot() +
  stat_compare_means(method = "t.test")

Bio19

```

```{r}
ggarrange(Bio1 + rremove("xlab") + rremove("legend"), Bio2 + rremove("xlab") + rremove("legend"), Bio3 + rremove("xlab") + rremove("legend"), Bio4 + rremove("xlab") + rremove("legend"), Bio5 + rremove("xlab") + rremove("legend"), Bio6 + rremove("xlab") + rremove("legend"), Bio7 + rremove("xlab") + rremove("legend"), Bio8 + rremove("xlab") + rremove("legend"), Bio9 + rremove("xlab") + rremove("legend"), Bio10 + rremove("xlab") + rremove("legend"), Bio11 + rremove("xlab") + rremove("legend"), Bio12 + rremove("xlab") + rremove("legend"), Bio13 + rremove("xlab") + rremove("legend"), Bio14 + rremove("xlab") + rremove("legend"), Bio15 + rremove("xlab") + rremove("legend"), Bio16 + rremove("xlab") + rremove("legend"), Bio17 + rremove("xlab") + rremove("legend"), Bio18 + rremove("xlab") + rremove("legend"), Bio19 + rremove("xlab") + rremove("legend"), ncol = 4, nrow = 5)
```

##Subset variables with significant differences between woody and herbaceous species
```{r}
MeanBioClim_small <- MeanBioClim
```

##Do a VIF analysis to exclude correlating variables
```{r}
vif(MeanBioClim_small[-c(1, 3, 5, 6, 7, 8, 9, 10, 11, 14)])
```

#try to make a model to use in phyloglm based on the boxplots and vif
```{r}
unique(Growth_Form$Name)
Formula_2 <- Growth_habit ~ BioClim1 + BioClim5 + BioClim9 + BioClim10
formula_1 <- Growth_habit ~ PETDriestQuarter + PETseasonality + aridityIndexThornthwaite + continentality + PETWettestQuarter + thermicityIndex
```

#make brench lengths 1 and extend branches
```{r}
BrassiToL_Lepidium_extended <- BrassiToL_Lepidium
edge_length <- replicate(46, 1)
BrassiToL_Lepidium_extended$edge.length <- edge_length
N <- Ntip(BrassiToL_Lepidium_extended)
root_node <- N+1
root_to_tip <- dist.nodes(BrassiToL_Lepidium_extended)[1:N, root_node]
var(root_to_tip)
age_difference <- max(root_to_tip) - root_to_tip
tip_edges <- BrassiToL_Lepidium_extended$edge[, 2] <= Ntip(BrassiToL_Lepidium_extended)
BrassiToL_Lepidium_extended$edge.length[tip_edges] <- BrassiToL_Lepidium_extended$edge.length[tip_edges] + age_difference
is.ultrametric(BrassiToL_Lepidium_extended)

plot(BrassiToL_Lepidium_extended)
## [1] TRUE
```

#PhyloGLM 
```{r}
fit <- phyloglmstep(formula = formula_1, data = Growth_Form, phy = BrassiToL_Lepidium_extended, btol = 50)
summary(fit)
```